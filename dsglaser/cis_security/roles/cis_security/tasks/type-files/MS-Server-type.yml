---
# Task file for CIS Controls
# This file is commented to help view what Ansible Automation is doing
#  and under what circumstances.

# Some blocks below have tasks with tags and some without. Blocks of tasks that
#  contain multiple controls have tasks with tags. Blocks that consist of a
#  single control and are just put together for convience sake, do not have
#  sub-block tasks with tags.

# Comments about how the modules are used will become more infrequent as
#  the file goes along to avoid repeating oneself.

  # Let the user know what version of the controls file is running
  # Use a variable so it prints out the correct version.
  - debug: msg="CIS Controls for {{ ansible_distribution }} {{ ansible_distribution_major_version }} type systems"

  - name: Determine if we are a domain controller
    set_fact:
      domain_role: "none"
    when: ansible_facts.windows_domain_role == "Stand-alone server"
  - set_fact:
      domain_role: "member"
    when: ansible_facts.windows_domain_role == "Member server"
  - set_fact:
      domain_role: "controller"
    when: ansible_facts.windows_domain_role == "Primary domain controller" or ansible_facts.windows_domain_role == "Backup domain controller"

  # The win_wsecurity_policy module modifies the security policy of the machine with the value
  #  supplied. You can get a list of the current settings on your system by running
  #  SecEdit.exe /export /cfg output.ini
  - name: 1.1.1 - Enforce password history is set to {{ password_history }} or more passwords
    win_security_policy:
      section: System Access
      key: PasswordHistorySize
      value: "{{ password_history }}"
    tags:
      - 1.1.1

  # 1.2.2 states that the max age should not be 0, if it is this will change the value to 60 automatically
  #  without telling the operator!
  # The ternary operator here is used to change the value of password_expire_days if it's
  #  value is less than 1.
  - name: 1.1.2 - Ensure maximum password age is set to "{{ password_expire_days }}" or fewer days, but not 0
    win_security_policy:
      section: System Access
      key: MaximumPasswordAge
      value: '{{ (password_expire_days|int < 1 ) | ternary(60, password_expire_days) }}'
    tags:
      - 1.1.2

  - name: 1.1.3 - Ensure minimum password age is set to "{{ password_min_days }}"
    win_security_policy:
      section: System Access
      key: MinimumPasswordAge
      value: "{{ password_min_days }}"
    tags:
      - 1.1.3

  - name: 1.1.4 - Ensure minimum password length is set to "{{ password_min_length }}"
    win_security_policy:
      section: System Access
      key: MinimumPasswordLength
      value: "{{ password_min_length }}"
    tags:
      - 1.1.4

  - name: 1.1.5 - Ensure 'Password must meet complexity requirements' is set to enbled
    win_security_policy:
      section: System Access
      key: PasswordComplexity
      value: 1
    tags:
      - 1.1.5

  - name: 1.1.6 - Ensure passwords are not stored with reversible encryption
    win_security_policy:
      section: System Access
      key: ClearTextPassword
      value: 0
    tags:
      - 1.1.5

  # The order for this controls has to be particular, if not they won't apply correctly.
  # 1.2.2 states that the threshold should not be 0, if it is this will change the value to 10 automatically
  #  without telling the operator!
  # The ternary operator here is used to change the value of account_lockout_threshold if it's
  #  value is less than 1.
  - name: 1.2.2 - Ensure Account lockout threshold is set to {{ account_lockout_threshold }} or fewer attempts, but not 0
    win_security_policy:
      section: System Access
      key: LockoutBadCount
      value: '{{ (account_lockout_threshold|int < 1 ) | ternary(10, account_lockout_threshold) }}'
    tags:
      - 1.2.2

  - name: 1.2.3 - Ensure Reset account lockout counter after is set to 15 or more minutes
    win_security_policy:
      section: System Access
      key: ResetLockoutCount
      value: '{{ (account_reset_duration|int < 15 ) | ternary(15, account_reset_duration) }}'
    tags:
      - 1.2.3

  - name: 1.2.1 - Ensure Account lockout duration is set to {{ account_lockout_duration }}
    win_security_policy:
      section: System Access
      key: LockoutDuration
      value: "{{ account_lockout_duration }}"
    tags:
      - 1.2.1

  - name: 2.2.1 - Ensure Access Credential Manager as a trusted caller is set to No One
    win_user_right:
      name: SeTrustedCredManAccessPrivilege
      users: []
      action: set
    tags:
      - 2.2.1

  # Control 2.2.2 is for Domain controllers only

  # Control 2.2.3 is for Member Servers only
  - name: 2.2.3 - Ensure Access this computer from network is restricted
    win_user_right:
      name: SeNetworkLogonRight
      users: "{{ network_logon_right }}"
      action: set
    tags:
      - 2.2.3

  - name: 2.2.4 - Ensure Act as part of operating system is set to no one.
    win_user_right:
      name: SeTcbPrivilege
      users: []
      action: set
    tags:
      - 2.2.4

  # 2.2.5 - is for DCs only

  - name: 2.2.6 - Ensure Adjust memory quotas for a process is restricted
    win_user_right:
      name: SeIncreaseQuotaPrivilege
      users: "{{ adjust_memory_quotas }}"
      action: set
    tags:
      - 2.2.6

  - name: 2.2.7 - Ensure Access this computer from console is restricted
    win_user_right:
      name: SeInteractiveLogonRight
      users: "{{ local_logon_right }}"
      action: set
    tags:
      - 2.2.7

  # 2.2.8 is for DCs only

  - name: 2.2.9 - Ensure allow long on through RDS is restricted
    win_user_right:
      name: SeRemoteInteractiveLogonRight
      users: "{{ rds_logon_right }}"
      action: set
    tags:
      - 2.2.9

  - name: 2.2.10 - Ensure backup operators are restricted
    win_user_right:
      name: SeBackupPrivilege
      users: "{{ backup_operators }}"
      action: set
    tags:
      - 2.2.10

  - name: 2.2.[11,12] - Ensure the ability to change the time is restricted
    win_user_right:
      name: SeSystemtimePrivilege
      users: "{{ time_operators }}"
      action: set
    loop:
      - SeSystemtimePrivilege
      - SeTimeZonePrivilege
    tags:
      - 2.2.11
      - 2.2.12

  - name: 2.2.13 - Ensure Create a page file is set to Administrator
    win_user_right:
      name: SeCreatePagefilePrivilege
      users: "Administrators"
      action: set
    tags:
      - 2.2.13

  - name: 2.2.14 - Ensure no one can create a token object
    win_user_right:
      name: SeCreateTokenPrivilege
      users: []
      action: set
    tags:
      - 2.2.14

  - name: 2.2.15 - Ensure Create Token object is restricted
    win_user_right:
      name: SeCreateGlobalPrivilege
      users:
        - "Administrators"
        - "LOCAL SERVICE"
        - "NETWORK SERVICE"
        - "SERVICE"
      action: set
    tags:
      - 2.2.15

  - name: 2.2.16 - Ensure no one can create permanent shared objects
    win_user_right:
      name: SeCreatePermanentPrivilege
      users: []
      action: set
    tags:
      - 2.2.16

  # Control 2.2.18 is only for DCs

  - name: 2.2.18 - Ensure symbolic link creation is restricted
    win_user_right:
      name: SeCreateSymbolicLinkPrivilege
      users: "{{ symbolic_link_right }}"
      action: set
    tags:
      - 2.2.18

  - name: 2.2.19 - Ensure 'Debug programs' is set to 'Administrators'
    win_user_right:
      name: SeDebugPrivilege
      users: "Administrators"
      action: set
    tags:
      - 2.2.19

  # Control 2.2.20 is only for DCs

  # Control 2.2.21 "Ensure 'Deny access to this computer from the network' to include 'Guests, Local account and member of Administrators group'" has a number of caveats and is function dependent: skipping

  - name: 2.2.[22-25] - Ensure deny local, remote, and batch logons includes 'Guests'
    win_user_right:
      name: "{{ item }}"
      users: "Guests"
      action: add
    loop:
      - SeDenyBatchLogonRight
      - SeDenyServiceLogonRight
      - SeDenyInteractiveLogonRight
      - SeDenyRemoteInteractiveLogonRight
    tags:
      - 2.2.22
      - 2.2.23
      - 2.2.24
      - 2.2.25

  # control 2.2.26, if configured will deny any local user from logging in remotely. need to test before implmentation: Skipping

  # Control 2.2.27 is only for DCs

  - name: 2.2.28 - Ensure 'Enable computer and user accounts to be trusted for delegation' is set to 'No One'
    win_user_right:
      name: SeEnableDelegationPrivilege
      users: []
      action: set
    when: domain_role == "member"
    tags:
      - 2.2.28

  - name: 2.2.29 - Ensure 'Debug programs' is set to 'Administrators'
    win_user_right:
      name: SeRemoteShutdownPrivilege
      users: "Administrators"
      action: set
    tags:
      - 2.2.29

  # Control 2.2.30 has a lot of exceptions for server roles. Skipping

  # 2.2.32 - A member server with Web Server (IIS) Role with Web Services role needs to have "IIS_IUSRS"
  #  added to this list, but DC's do not. Disable on member services if you have the above roles
  - name: 2.2.31 - Ensure 'Impersonate a client after authentication' is restricted
    win_user_right:
      name: SeImpersonatePrivilege
      users:
        - "Administrators"
        - "LOCAL SERVICE"
        - "NETWORK SERVICE"
        - "SERVICE"
      action: set
    tags:
      - 2.2.31

  - name: 2.2.33 - Ensure 'Increase scheduling priority' is restricted
    win_user_right:
      name: SeIncreaseBasePriorityPrivilege
      users:
        - Administrators
        - 'Window Manager\Window Manager Group'
      action: set
    tags:
      - 2.2.33

  - name: 2.2.34 - Ensure 'Load and unload device drivers' is restricted
    win_user_right:
      name: SeLoadDriverPrivilege
      users: "Administrators"
      action: set
    tags:
      - 2.2.34

  - name: 2.2.35 - Ensure 'Lock pages in memory' is set to 'No One'
    win_user_right:
      name: SeLockMemoryPrivilege
      users: []
      action: set
    tags:
      - 2.2.35

  - name: 2.2.36 - Ensure 'Log in as a batch job is set to 'Administrators'
    win_user_right:
      name: SeBatchLogonRight
      users:
        - Administrators
      action: set
    when: domain_role == "controller"
    tags:
      - 2.2.36

  # If you are running an Exchange environment, exclude this task (both tags!) on DCs and include "Exchange Servers" in
  #  an Exchange server playbook/role
  - name: 2.2.[37,38] - Ensure 'Manage auditing and security log' is set to Adminstrators
    win_user_right:
      name: SeSecurityPrivilege
      users:
        - Administrators
      action: set
    tags:
      - 2.2.37
      - 2.2.38

  - name: 2.2.39 - Ensure 'Modify an object label' is set to 'No One'
    win_user_right:
      name: SeRelabelPrivilege
      users: []
      action: set
    tags:
      - 2.2.39

  - name: 2.2.40 - Ensure 'Modify firmware environment values' is set to 'Administrators'
    win_user_right:
      name: SeSystemEnvironmentPrivilege
      users:
        - Administrators
      action: set
    tags:
      - 2.2.41

  - name: 2.2.41 - Ensure 'Perform volume maintenance tasks' is set to 'Administrators'
    win_user_right:
      name: SeManageVolumePrivilege
      users:
        - Administrators
      action: set
    tags:
      - 2.2.41

  - name: 2.2.42 - Ensure 'Profile single process' is set to 'Administrators'
    win_user_right:
      name: SeProfileSingleProcessPrivilege
      users:
        - Administrators
      action: set
    tags:
      - 2.2.42

  - name: 2.2.43 - Ensure 'Profile system performance' is restricted
    win_user_right:
      name: SeSystemProfilePrivilege
      users:
        - Administrators
        - 'NT Service\WdiServiceHost'
      action: set
    tags:
      - 2.2.43

  - name: 2.2.44 - Ensure 'Replace a process level token' is restricted
    win_user_right:
      name: SeAssignPrimaryTokenPrivilege
      users:
        - 'LOCAL SERVICE'
        - 'NETWORK SERVICE'
      action: set
    tags:
      - 2.2.44

  - name: 2.2.45 - Ensure 'Restore files and directories' is set to 'Administrators'
    win_user_right:
      name: SeRestorePrivilege
      users:
        - Administrators
      action: set
    tags:
      - 2.2.45

  - name: 2.2.46 - Ensure 'Shut down the System' is set to 'Administrators'
    win_user_right:
      name: SeShutdownPrivilege
      users:
        - Administrators
      action: set
    tags:
      - 2.2.46

  - name: 2.2.47 - Ensure 'Synchronize directory service data' is set to 'No One'
    win_user_right:
      name: SeSyncAgentPrivilege
      users: []
      action: set
    when: domain_role == "controller"
    tags:
      - 2.2.47

  - name: 2.2.48 - Ensure 'Take ownership of files or other objects' is set to 'Administrators'
    win_user_right:
      name: SeTakeOwnershipPrivilege
      users:
        - Administrators
      action: set
    tags:
      - 2.2.48

  # 2.3.1 - Disable Administrator Account

  - name: 2.3.1.2 - Ensure 'Accounts - Block Microsoft accounts' is set to 'Users can't add or log on with Microsoft accounts'
    win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      name: NoConnectedUser
      data: 3
      type: dword
    tags:
      - 2.3.1.2

  - name: 2.3.1.3 - Ensure 'Accounts - Guest account status' is set to 'Disabled'
    win_security_policy:
      section: System Access
      key: EnableGuestAccount
      value: '1'
    when: enable_guest
    tags:
      - 2.3.1.3

  - name: 2.3.1.3 - Ensure 'Accounts - Guest account status' is set to 'Disabled'
    win_security_policy:
      section: System Access
      key: EnableGuestAccount
      value: '0'
    when: enable_guest | lower == "false"
    tags:
      - 2.3.1.3

  - name: 2.3.1.4 - Ensure 'Accounts - Limit local account use of blank passwords to console logon only' is set to 'Enabled'
    win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      name: LimitBlankPasswordUse
      data: 1
      type: dword
    tags:
      - 2.3.1.4

  - name: 2.3.1.5 - Rename Administrator account
    win_security_policy:
      section: System Access
      key: NewAdministratorName
      value: '{{ rename_Administrator }}'
    when: (enable_Administrator | lower) == "true"
    tags:
      - 2.3.1.5

  - name: 2.3.1.6 - Rename Guest account
    win_security_policy:
      section: System Access
      key: NewGuestName
      value: '{{ rename_Administrator }}'
    when: (enable_guest | lower) == "true"
    tags:
      - 2.3.1.6

  # 2.3.2 - Audit

  - name: 2.3.2.1 - Force audit policy subcategories to override category settings
    win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      name: SCENoApplyLegacyAuditPolicy
      data: 1
      type: dword
    tags:
      - 2.3.2.1

  - name: 2.3.2.2 - Ensure system does not shut down if unable to log security audits
    win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      name: CrashOnAuditFail
      data: 0
      type: dword
    tags:
      - 2.3.2.2

  # 2.3.3 - Intentionally blank

  - name: 2.3.4.1 - Ensure only Administrators can format and eject removeable hardware
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon'
      name: AllocateDASD
      data: 0
      type: dword
    tags:
      - 2.3.4.1

  - name: 2.3.4.2 - Prevent Users from installing print drivers
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Print\Providers\LanMan Print Services\Servers'
      name: AddPrinterDrivers
      data: 1
      type: dword
    tags:
      - 2.3.4.2

  # 2.3.5 - Domain controller settings
  - name: 2.3.5 - Domain controller specific settings
    block:
      - name: 2.3.5.1 - Allow server operators to schedule tasks
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
          name: SubmitControl
          data: 0
          type: dword
        tags:
          - 2.3.5.1

      # This control can have severe effects with really old clients (win 2000 SP3 and earlier) verify
      #  the effect of this control before implementing
      - name: 2.3.5.2 - Require LDAP signing
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters'
          name: LDAPServerIntegrity
          data: "Require signing"
          type: string
        tags:
          - 2.3.5.2

      - name: 2.3.5.3 - Refuse machine account password changes set to disabled
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
          name: RefusePasswordChange
          data: 0
          type: dword
        tags:
          - 2.3.5.3
    when: domain_role == "controller"
    tags:
      - 2.3.5

  # 2.3.6 - Domain member settings (controllers and member servers)
  - name: 2.3.6 - Domain members specific settings (controllers and member servers)
    block:
      - name: 2.3.6.1 - Digitally encrypt or sign secure channel data (always)
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
          name: RequireSignOrSeal
          data: 1
          type: dword
        tags:
          - 2.3.6.1

      - name: 2.3.6.2 - Digitally secure channel data (when possible)
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
          name: SealSecureChannel
          data: 1
          type: dword
        tags:
          - 2.3.6.2

      - name: 2.3.6.3 - Digitally sign secure channel data (when possible)
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
          name: SignSecureChannel
          data: 1
          type: dword
        tags:
          - 2.3.6.3

      - name: 2.3.6.4 - Disable machine account password changes
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
          name: DisablePasswordChange
          data: 0
          type: dword
        tags:
          - 2.3.6.4

      # Make sure you understand the impacts of this setting, or exclude it.
      - name: 2.3.6.5 - Maximum machine account password age
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
          name: MaximumPasswordAge
          data: '{{ (max_machine_account_days|int < 1 ) | ternary(30, max_machine_account_days) }}'
          type: dword
        tags:
          - 2.3.6.5

      - name: 2.3.6.6 - Require strong session key
        win_regedit:
          path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
          name: RequireStrongKey
          data: 1
          type: dword
        tags:
          - 2.3.6.6
    when: domain_role == "controller" or domain_role == "member"
    tags:
      - 2.3.6

  # 2.3.7 - Interactive Logon
  - name: 2.3.7.1 - Disable CAD Requirement
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: DisableCAD
      data: 0
      type: dword
    tags:
      - 2.3.7.1

  - name: 2.3.7.2 - Don't disply last signed in user
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: DontDisplayLastUserName
      data: 1
      type: dword
    tags:
      - 2.3.7.2

  - name: 2.3.7.3 - Machine inactivtiy limit set to {{ inactivity_timeout }} but not 0
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
      name: InactivityTimeoutSecs
      data: '{{ (inactivity_timeout|int < 1 ) | ternary(900, inactivity_timeout) }}'
      type: dword
    tags:
      - 2.3.7.3

  # 2.3.7.[4,5] - Message text for users attempting to log in: skipped

  - name: 2.3.7.6 - Number of cached logins set to {{ cached_logins }} or fewer
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon'
      name: CachedLogonsCount
      data: "{{ cached_logins }}"
      type: dword
    when: domain_role == "member"
    tags:
      - 2.3.7.6

  - name: 2.3.7.7 - Number of days for password change warning {{ cached_logins }}
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon'
      name: PasswordExpiryWarning
      data: "{{ password_warning_days }}"
      type: dword
    tags:
      - 2.3.7.7

  # if you have machines which need local cached credentials (such as a disconnected server), do not enable this
  #  because without a DC connection, you will not be able to unlock your machine
  - name: 2.3.7.8 - Require domain controller authentication to unlock workstation
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon'
      name: ForceUnlockLogon
      data: 1
      type: dword
    tags:
      - 2.3.7.8

  - name: 2.3.7.9 - Smart-card removal behavior
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon'
      name: ScRemoveOptions
      data: "{{ smart_card_removal }}"
      type: dword
    when: smart_card_removal == "1" or smart_card_removal == "2" or smart_card_removal == "3"
    tags:
      - 2.3.7.9

  # 2.3.8 - Microsoft network client

  # This control can cause a performance hit due to the need to sign every packet.
  - name: 2.3.8.1 - Require SMB packet signing
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManWorkstation\Parameters'
      name: RequireSecuritySignature
      data: 1
      type: dword
    tags:
      - 2.3.8.1

  - name: 2.3.8.2 - Sign communications (if server agrees)
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManWorkstation\Parameters'
      name: EnableSecuritySignature
      data: 1
      type: dword
    tags:
      - 2.3.8.2

  - name: 2.3.8.3 - send uncencrypted password to third-party SMB servers
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManWorkstation\Parameters'
      name: EnablePlainTextPassword
      data: 0
      type: dword
    tags:
      - 2.3.8.3

  # 2.3.9 - Microsoft network server
  - name: 2.3.9.1 - SMB inactivty suspension
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters'
      name: AutoDisconnect
      data: "{{ smb_inactivity_minutes }}"
      type: dword
    tags:
      - 2.3.9.1

  # This control can cause a performance hit due to the need to sign every packet.
  - name: 2.3.9.2 - Digitally sign communications (always)
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters'
      name: RequireSecuritySignature
      data: 1
      type: dword
    tags:
      - 2.3.9.2

  - name: 2.3.9.3 - Digitally sign communications (if client agrees)
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters'
      name: EnableSecuritySignature
      data: 1
      type: dword
    tags:
      - 2.3.9.3

  - name: 2.3.9.4 - Disconnect clients when logon hours expire
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters'
      name: enableforcedlogoff
      data: 1
      type: dword
    tags:
      - 2.3.9.4

  - name: 2.3.9.5 - SPN target name validation level
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters'
      name: SMBServerNameHardeningLevel
      data: "{{ snp_level }}"
      type: dword
    when: snp_level == "1" or snp_level == "2"
    tags:
      - 2.3.9.5

  # 2.3.10 Network Access
  # control 2.3.10.1 - Disallow anonymous SID/Name translation disabled until constant is discovered

  - name: 2.3.10.2 - Do not allow enumeration of SAM accounts
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: RestrictAnonymousSAM
      data: 1
      type: dword
    tags:
      - 2.3.10.2

  - name: 2.3.10.3 - Do not allow enumeration of SAM accounts and shares
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: RestrictAnonymous
      data: 1
      type: dword
    when: domain_role == "member"
    tags:
      - 2.3.10.3

  - name: 2.3.10.4 - Do not allow storage of passwords and creds for network auth
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: DisableDomainCreds
      data: 1
      type: dword
    tags:
      - 2.3.10.4

  - name: 2.3.10.5 - Let 'Everyone' permissions apply to anonymous users is disabled
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: EveryoneIncludesAnonymous
      data: 0
      type: dword
    tags:
      - 2.3.10.5

  - name: 2.3.10.6 - Named pipes can be accessed anonymously (DC only)
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: NullSessionPipes
      data: ['LSARPC', 'NETLOGON', 'SAMR']
      type: multistring
    when: domain_role == "controller"
    tags:
      - 2.3.10.6

  - name: 2.3.10.7 - Named pipes can be accessed anonymously (member servers)
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: NullSessionPipes
      data: []
      type: multistring
    when: domain_role == "member"
    tags:
      - 2.3.10.7

  - name: 2.3.10.8 - Remotely accessible registry paths
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: NullSessionPipes
      data: ['System\CurrentControlSet\Control\ProductOptions', 'System\CurrentControlSet\Control\Server Applicatoins', 'Software\Microsoft\Windows NT\CurrentVersion']
      type: multistring
    tags:
      - 2.3.10.8

  # TODO - check server roles and add extra paths as needed
  - name: 2.3.10.9 - Remotely accessible registry paths and subpaths
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: NullSessionPipes
      data: >
        ['System\CurrentControlSet\Control\Print\Printers',
        'System\CurrentControlSet\Services\Eventlog',
        'Software\Microsoft\OLAP Server',
        'Software\Microsoft\Windows NT\CurrentVersion\Print',
        'Software\Microsoft\Windows NT\CurrentVersion\Windows',
        'System\CurrentControlSet\Control\ContentIndex',
        'System\CurrentControlSet\Control\Terminal Server',
        'System\CurrentControlSet\Control\Terminal Server\UserConfig',
        'System\CurrentControlSet\Control\Terminal Server\DefaultUserConfiguration',
        'Software\Microsoft\Windows NT\CurrentVersion\Perflib',
        'System\CurrentControlSet\Services\SysmonLog']
      type: multistring
    tags:
      - 2.3.10.9

  - name: 2.3.10.10 - Restrict anonymous access to named pipes
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters'
      name: RestrictNullSessAccess
      data: 1
      type: dword
    tags:
      - 2.3.10.10

  - name: 2.3.10.11 - Restrict anonymous access to named pipes
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: restrictremotesam
      data: 'O:BAG:BAD:(A;;RC;;;BA)'
      type: dword
    when: domain_role == "member"
    tags:
      - 2.3.10.11

  - name: 2.3.10.12 - Clear all shares that can be accessd anonymously
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters'
      name: NullSessionShares
      state: absent
      delete_key: no
    tags:
      - 2.3.10.12

  - name: 2.3.10.13 - Local users authenticate as themselves
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: ForceGuest
      data: 0
      type: dword
    tags:
      - 2.3.10.13

  # 2.3.11 - Network Security
  - name: 2.3.11.1 - Use machine ID for NTLM
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: UseMachineId
      data: 1
      type: dword
    tags:
      - 2.3.11.1

  - name: 2.3.11.2 - Disallow LocalSystem NULL session fallback
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0'
      name: AllowNullSessionFallback
      data: 0
      type: dword
    tags:
      - 2.3.11.2

  - name: 2.3.11.3 - Disallow PKU2U auth requests
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\pku2u'
      name: AllowOnlineID
      data: 0
      type: dword
    tags:
      - 2.3.11.3

  # Find the control to read up on this. The encryption types get converted to a dword in the
  #  registry, so the allowed types from the control are added here. Other choices will require
  #  you to add them and pull the converted dword to change
  - name: 2.3.11.4 - Supported Kerberos encryption types
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters'
      name: SupportedEncryptionTypes
      data: 2147483640
      type: dword
    tags:
      - 2.3.11.4

  - name: 2.3.11.5 - Do not store LAN Manager hash on password change
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: NoLMHash
      data: 1
      type: dword
    tags:
      - 2.3.11.5

  - name: 2.3.11.6 - Force Logoff when logon hours expire
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: NoLMHash
      data: 1
      type: dword
    tags:
      - 2.3.11.6

  - name: 2.3.11.7 - LAN Manager authentication - Send NTLMv2 reponse, refuse LM & NTLM
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: LmCompatibilityLevel
      data: 5
      type: dword
    tags:
      - 2.3.11.7

  - name: 2.3.11.8 - LDAP Client signing
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Services\LDAP'
      name: LDAPClientIntegrity
      data: "{{ ldap_client_signing }}"
      type: dword
    when: ldap_client_signing|int > "0" and ldap_client_signing|int < "3"
    tags:
      - 2.3.11.8

  # TODO -  2.3.11.9 - Set minimum security for NTLM SSP based clients
  # TODO -  2.3.11.10 - Set minimum security for NTLM SSP based servers


  # 2.3.12 - Recovery console - no controls in 2019 Server

  # 2.3.13 - Shutdown
  - name: 2.3.13.1 - Disable system from shuting down without having to log on
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      name: ShutdownWithoutLogon
      data: 0
      type: dword
    tags:
      - 2.3.13.1

  # 2.3.14 - System cryptography - no controls for 2019 Server

  # 2.3.15 - System objects
  - name: 2.3.15.1 - Require case insensitivity for now windows subsystems
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Kernel'
      name: ObCaseInsensitive
      data: 1
      type: dword
    tags:
      - 2.3.15.1

  - name: 2.3.15.2 - Streghten default permissions of system objects
    win_regedit:
      path: 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Kernel'
      name: ProtectionMode
      data: 1
      type: dword
    tags:
      - 2.3.15.2

  # 2.3.16 - System Settings - No controls for 2019 Server

  # 2.3.17 - User Account Control
  - name: 2.3.17.1 - Ensure UAC, admin approval mode for built-in admin account is enabled
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: FilterAdministratorToken
      data: 1
      type: dword
    when: domain_role == "member" or domain_role == "controller"
    tags:
      - 2.3.17.1

  - name: 2.3.17.2 - Ensure UAC, behavior of the elevation prompt for admins
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: ConsentPromptBehaviorAdmin
      data: "{{{ uac_prompt_for_consent_admin }}"
      type: dword
    tags:
      - 2.3.17.2

  - name: 2.3.17.3 - Ensure UAC, behavior of the elevation prompt for standard users
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: ConsentPromptBehaviorUser
      data: "{{{ uac_prompt_for_consent_user }}"
      type: dword
    tags:
      - 2.3.17.3

  - name: 2.3.17.4 - Ensure UAC, direct app installations prompt for elevation
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: EnableInstallerDetection
      data: 1
      type: dword
    tags:
      - 2.3.17.4

  - name: 2.3.17.5 - Ensure UAC, Only elevate UIAccess aps that are installed in secure location
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: EnableSecureUIAPaths
      data: 1
      type: dword
    tags:
      - 2.3.17.5

  - name: 2.3.17.6 - Ensure UAC, Run all admins in Admin Approval Mode
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: EnableLUA
      data: 1
      type: dword
    tags:
      - 2.3.17.6

  - name: 2.3.17.7 - Ensure UAC, Switch to secure desktop when prompting for elevation
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: PromptOnSecureDesktop
      data: 1
      type: dword
    tags:
      - 2.3.17.7

  - name: 2.3.17.8 - Ensure UAC, Virtualize file and registry write failures to per-user locations
    win_regedit:
      path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      name: EnableVirtualization
      data: 1
      type: dword
    tags:
      - 2.3.17.8

  # 3 Event Log - No controls for Server 2019

  # 4 Restricted Groups - No controls for Server 2019

  # 5 System Services - No controls for Server 2019

  # 6 Registry - No contorls for Server 2019

  # 7 File System - No controls for Server 2019

  # 8 Wired Network - No controls for Serer 2019

  # 9 Windows Firewall - TODO

  # 10 Network List Manager Policies - No controls for Server 2019

  # 11 Wireless network policies - No controls for Server 2019

  # 12 Public Key Policies - No controls for Server 2019

  # 13 Software Restriction Policies - No controls for Server 2019

  # 14 NAP client configuratin - No controls for Server 2019

  # 15 Application Control Policies - No controls for Server 2019

  # 16 IP Security Policies - No controls for Server 2019

  # 17 Advanced Audit Policy Configuration
  - name: 17.1.1 - Ensure Audit credential validation is set to 'success and failure'
    win_audit_policy_system:
      subcategory: "Audit Credential Validation"
      audit_type: success, failure
    tags:
      - 17.1.1

